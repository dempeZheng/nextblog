---
layout: post
title:  "金钱灾备跨机房自动切换落地实践"
date:  2018-04-02 12:39:04
type: 灾备
categories: [高可用]
keywords: 灾备,跨机房,自动切换,mha
---
## 现状
金钱业务存在余额扣减问题，异地多活实现难度较大，现阶段金钱灾备为同城冷备。冷备节点则面临切换问题。
1）真正突发故障是否敢切？
2）人工切换风险高
3）人工切换耗时久
4）切换后数据一致性如何保证，如何快速恢复

## 方案
为解决上述问题，我们采用`mysql mha` 解决db自动切换问题，从`业务止损方案`来规避自动切换带来数据风险。预先生成`数据一键恢复`来应对极端情况。

业务架构图如下：
![Alt text](/images/1522478891953.png)

### mysql mha+consul数据库自动切换
![Alt text](/images/1522478907544.png)

### 业务止损方案
止损要解决的问题就是尽可能的减少用户超扣的场景，减少超扣首要要解决的是db切换后数据一致性问题，mha灾备自动切换已经解决了一部分问题，但是并不能完全保证数据一致。（我们考虑业务层止损，首要原因是对mha把控能力不强）
讨论业务层止损方案的前提是假设mha切换后，数据不一致的场景。
减少损失，主要从两个角度
1）机房同步延时监控，发现延时超过3min钟，即告警，通知dba处理
假定我们可以接受的最大不同步时间为10min，那我们尽可能保证主从同步延时在10min钟内，那么整个损失大概率还是可控的。
2）业务逻辑止损
我们可以在缓存里面维护一份用户余额，在触发db切换事件后，比对缓存余额，发现余额不一致的场景，将用户 加入冻结黑名单，只给充值类行为，不给扣减。
![Alt text](/images/1522488199070.png)


### 故障分析&数据恢复
1）mysql binlog 恢复
比较简单，没有关联业务可以考虑同步mysql binlog来恢复，通过binlog还原故障时间的binlog，然后人工按需要执行。
2）根据业务逻辑还原
第一种还原方法较为通用，且不依赖故障db，只要能拿到对应的binlog，即可以还原。但是对于复杂的有关联的业务，无法做到精细的恢复，特别是涉及到多个库有关联关系的恢复，基本束手无策。（对于余额扣减不够扣，sql执行失败，但是后面sql可能都执行成功，这些是很难容忍的）
针对业务细节问题，针对具体的业务具体恢复比较靠谱。
![Alt text](/images/1522488223612.png)


## 优化

1） mysql 半同步
2）用户分区，双向赋值，减少故障影响范围

## 后记

mysql mha