---
layout: post
title:  "电路熔断器模式"
date:  2017-08-30
categories: [微服务]
keywords: 微服务,熔断器,hystrix,Circuit,Breaker
---

## 概念

电路熔断器模式(`Circuit Breaker Patten`), 该模式的原理类似于家里的电路熔断器，如果家里的电路发生短路，熔断器能够主动熔断电路，以避免灾难性损失。在分布式系统中应用电路熔断器模式后，当目标服务慢或者大量超时，调用方能够主动熔断，以防止服务被进一步拖垮；如果情况又好转了，电路又能自动恢复，这就是所谓的弹性容错，系统有自恢复能力。下图Fig 8是一个典型的具备弹性恢复能力的电路保护器状态图，正常状态下，电路处于关闭状态(Closed)，如果调用持续出错或者超时，电路被打开进入熔断状态(Open)，后续一段时间内的所有调用都会被拒绝(Fail Fast)，一段时间以后，保护器会尝试进入半熔断状态(Half-Open)，允许少量请求进来尝试，如果调用仍然失败，则回到熔断状态，如果调用成功，则回到电路闭合状态。

## 应用场景

一般是指软件系统中，由于某些原因使得服务出现了过载现象，为防止造成整个系统故障，从而采用的一种保护措施，所以很多地方把熔断亦称为过载保护。很多时候刚开始可能只是系统出现了局部的、小规模的故障，然而由于种种原因，故障影响的范围越来越大，最终导致了全局性的后果。

## Hystrix Circuit Breaker Netflix
对电路熔断器提供了标准的实现，目前业界的所说的熔断大部分也是指的 Hystrix Circuit Breaker。

![Alt text](./circuit-breaker-1280.png)

**电路断路器的开闭模式如下：**
1.假定请求达到一个确定的阈值，（熔断器在整个统计时间内是否开启的阀值，默认20秒。也就是10秒钟内至少请求20次，熔断器才发挥起作用 ，如果低于这个阈值，就不会走熔断器的逻辑）
(HystrixCommandProperties.circuitBreakerRequestVolumeThreshold())...
2.假定失败率百分比超过一个确定的阈值，
(HystrixCommandProperties.circuitBreakerErrorThresholdPercentage())...
3.然后，电路断路器由闭合状态变为打开状态，
4.一旦断路器打开，经由这个断路器的所有请求都短路了。
5.经过一段时间
(HystrixCommandProperties.circuitBreakerSleepWindowInMilliseconds())
下一个请求被允许通过，(这就是 HALF-OPEN 状态)如果这个请求失败了，断路器模式转变为断开，持续一个时间段。如果请求成功，断路器转变为闭合的状态，然后跳到1逻辑，循环。

【注】熔断器如果能配置负载均衡就很完美了，在某个节点触发熔断时，自动隔离，一段时间后半开状态，...


每个熔断器默认维护10个bucket,每秒一个bucket,每个blucket记录成功,失败,超时,拒绝的状态，
默认错误超过50%且10秒内超过20个请求进行中断拦截.

###   熔断器的状态机

**Closed**：熔断器关闭状态，调用失败次数积累，到了阈值（或一定比例）则启动熔断机制；
**Open**：熔断器打开状态，此时对下游的调用都内部直接返回错误，不走网络，但设计了一个时钟选项，默认的时钟达到了一定时间（这个时间一般设置成平均故障处理时间，也就是MTTR），到了这个时间，进入半熔断状态；
**Half-Open**：半熔断状态，允许定量的服务请求，如果调用都成功（或一定比例）则认为恢复了，关闭熔断器，否则认为还没好，又回到熔断器打开状态；


### 熔断器相关配置

| 参数           | 作用          | 备注    |
| ------------- |:-------------:| -----:|
|circuitBreaker.errorThresholdPercentage     | 失败率达到多少百分比后熔断	 | 默认值：50 |
| circuitBreaker.forceClosed      | 是否强制关闭熔断	`如果是强依赖，应该设置为true`|   |
| circuitBreaker.requestVolumeThreshold | 熔断触发的最小个数/10s      |   默认值：20 |
| circuitBreaker.sleepWindowInMilliseconds | 熔断多少秒后去尝试请求     |   默认值：5000 |




## 后记
熔断器还有其他的方式实现，比如vip就用了metrics中的SlidingTimeWindowReservoir来实现熔断器。
SlidingTimeWindowReservoir中的 ConcurrentSkipListMap会导致YGC时间变长，详见

## 参考资料

https://github.com/Netflix/Hystrix/wiki/How-it-Works#CircuitBreaker
http://www.infoq.com/cn/articles/basis-frameworkto-implement-micro-servic