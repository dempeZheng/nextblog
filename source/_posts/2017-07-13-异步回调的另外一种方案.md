---
layout: post
title:  "异步回调通知的另一种方案"
date:  2017-07-13
categories: [队列]
keywords: 队列,回调
---


## 场景
最近在做一个签约续费的服务，面临各种不同的回调，不同渠道的签约回调，解约回调，扣费回调等。我们需要处理这些回调，然后将这些回调通知业务方。

这种应该是用队列的标准场景，一开始也是决定引入队列。但是由于老板考虑到维护成本，而内部有没有一个可靠的队列可用。所以队列的方案pass掉了。

那么问题来了，不能用队列，面对这么多回调，怎么通知业务方呢？

## 解决方案
比较挫的方案是：当签约网关服务回调过来了，我们处理完逻辑，然后调用业务方接口通知业务方。通知成功我们再ack消息。依赖签约网关服务的回调策略保障消息的可靠。
说这种方法比较挫，是因为虽然它保障了通知消息的可靠性，但是整条链路的耦合非常严重。比如通知业务方失败，然后整条通知的链路需要重试。同时也会增加上层签约网关的负担。

另外一种比较挫的方案是：当签约网关服务回调过来，处理完逻辑，将消息落地到db。写入db成功就立即ack消息。
通知消息写入db，然后再来一个定时的task，定时将没有通知的消息，通知给业务方。写入db，想怎么玩都是可以实现。

这种方案的缺点：相比队列，性能要差很多。灵活性也差。
但是也有优点，优点就是靠谱，很容易查到每条消息的通知状态。通知策略也比较容易定制。

## 定时通知的Task

### 注意的问题
定时的task应该是单线程，然后执行通知的线程池最好是线程池。并行来提高通知效率。
定时的task是单线程是因为每次需要从db拉取一个时间段的未通知的消息列表。多线程容易产生重复通知的问题。

----
实践的部分后面做...



