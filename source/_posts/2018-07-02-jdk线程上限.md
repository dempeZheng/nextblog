---
layout: post
title:  "jdk线程上限"
date:  2018-07-02 12:39:04
type: shell
categories: [线程]
keywords: jdk线程,线程数量
---
java线程是宝贵的资源，我们在使用的时候都应该尽量用池化的技术来避免线程滥用。但是近来，服务拆分粒度越来越细，依赖服务线程隔离使用的场景越来越多。一个系统很容易线程数量达到四五千。那么java线程数量到底受什么制约，或者书java线程数量的上限究竟是多少？
要知道java线程上限，首先我们要了解操作系统的线程
## 操作系统线程分类
1）用户级线程  
2）内核级线程  
3）混合模型  

## jdk线程的实现
jdk是基于基于内核级线程（1:1）实现的

知道了jdk线程的实现，其实我们已经可以知道jdk线程的上线取决于操作系统的线程上限。
那么操作系统线程的上限取决于什么呢？

## 操作系统线程上限

### 操作系统线程上限配置
1） `/proc/sys/kernel/pid_max` #查系统支持的最大线程数，一般会很大，相当于理论值

```
65536
```
2）`/proc/sys/kernel/threads-max`  # 系统可生成的最大线程数

```
1030058
```
3）`max_user_process` #系统限制某用户下最多可以运行多少进程或线程，使用命令:`ulimit -u`

```
515029
```
> 注：修改max_user_process的数值，只需要修改`/etc/security/limits.conf`即可，但是这个参数需要修改`/etc/security/limits.d/90-nproc.conf`

查看了一下服务器，这几个值都比较大，但是如果说操作系统的线程上限取决于这几个值，那么我们真能创建6w多个java线程？
这个当然不成立，每个线程也会会占用一定内存的。线程还会受内存制约
### jdk线程数量受内存制约
这里有一个问题，jdk的线程数量到底是受操作系统内存制约 还是受jvm内存制约呢？
上面我们提到，jdk系统是基于操作系统内核线程实现的，所以，jdk线程其实占用的是系统内存。所以有的时候我们分配给jvm的内存越大，反而jdk可以创建的线程越少了。

这个问题之前碰到过一次，也有对应的总结。
包括  
1）jdk线程数量  
2）jdk线程占用内存大小  
具体详见[记一次OutOfMemoryError: unable to create new native thread](http://zhizus.com/2017-07-31-%E8%AE%B0%E4%B8%80%E6%AC%A1OutOfMemoryError.html)

既然jdk线程数量收操作系统内存制约，那么jdk线程的上限怎么算呢？


## 当前系统线程数量的查看

以下两种方式都可以查看某个进程的线程数量

```
pstree -p 进程号 | wc -l
top -H 进程号 | wc -l
```
整个操作系统的线程数量 可以用一下命令查看

```
pstree -p  | wc -l
```

## 总结
不了解的jdk线程实现的很容易误认为jdk线程占用的是jvm内存。这个很容易对jdk线程数量上限及jdk占用系统内存造成误判。