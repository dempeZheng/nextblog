---
layout: post
title:  "微服务下，如何保证服务可用性"
date:  2017-07-09
categories: [实践微服务]
keywords: spring cloud,hystrix,微服务
---


## 背景
最近经常被强调最多就是弱依赖降级，强依赖重试，db服务容灾的。被强调的原因是已经有好几例由于由于网络原因造成的重大事故了。
如今，微服务有兴起的苗头，已经感觉到很多公司都在尝试基于spring cloud来建设微服务，虽然不一定成型，但是服务已经被拆的越来越细。在这种情况下，我们经常被要求服务高可用，那么服务高可用到底需要具备哪些特征呢。


## 高可用服务基本特征
下面的每个点都值得深入写一篇博客，深入的学习和探讨。
### 服务容灾

`舱壁隔离模式`,
`电路断路器模式`,
`服务降级`,
`服务限流`,
`服务分流`,
`超时`,
`服务重试机制`
对于服务容灾，已经不是一个新鲜的话题了，淘宝的dubbo，新浪的motan都实现了简单的容灾策略。但是这两个对服务容灾的实现都比较简陋。如motan早期仅仅实现了failfast和failover的容灾策略。尽管这两种是最简单有效的策略，使用者也可以自行进行扩展容灾策略。但是依然还是会有些受限。至少不像Hystrix那么优雅。
#### 电路断路器模式
[电路断路器模式](http://code.zhizus.com/2017-08-30-%E7%94%B5%E8%B7%AF%E7%94%B5%E8%B7%AF%E5%99%A8%E6%A8%A1%E5%BC%8F.html)


#### 重试机制
对于不够稳定的强依赖的服务，我们没办法做降级处理，这个时候可以依赖重试机制来服务的可靠性。
关于重试机制的深入了解，详见[重试机制](http://code.zhizus.com/2017-08-26-%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6.html)


#### 弱依赖降级
对于弱依赖，这种情况下Hystrix比较好办，直接实现fallback方法，失败的时候直接交由fallback处理。fallback方法里面可以返回默认值。
#### 舱壁隔离

### 服务隔离
服务隔离按粒度又可以分为进程隔离和线程隔离。我们 可以同时做到进程隔离，然后在进程内做线程隔离。
#### 进程隔离
现在比较老的服务一般都是一个服务包含很多功能，比如既包含用户服务，有包含支付服务。当用户服务不可用的时候，导致支付服务不可用，这样是不合理的。所以对于这些明显属于两种不同职责的服务，我们有必要将其拆成不同的服务进程。隔离起来，相互不影响。

#### 线程隔离
国内的RPC对线程隔离实现的都比较弱。这里还是推荐Netflix的Hystrix，不同的Command可以使用不同的线程池。

### 服务限流
限流的目的是通过对并发访问 / 请求进行限速或者一个时间窗口内的的请求进行限速来保护系统**，一旦达到限制速率则可以拒绝服务（可以直接丢弃请求，或者将溢出请求排队，引流等）
关于限流的深入了解，详见[高并发利器之限流](http://code.zhizus.com/2017-07-11-%E9%AB%98%E5%B9%B6%E5%8F%91%E5%88%A9%E5%99%A8%E6%94%AF%E9%99%90%E6%B5%81.html)

### 服务监控

### 幂等
[幂等](http://code.zhizus.com/2017-08-28-%E5%B9%82%E7%AD%89.html)

### 日志

### 超时

### 单点问题
#### 应用单点
####  缓存单点
#### db单点

## 后记
以spring cloud的生态链应该就是以后java技术栈的大趋势了，spring 包装netflix的组件对上面的大多数问题基本上都给出了优雅的解决方案。
