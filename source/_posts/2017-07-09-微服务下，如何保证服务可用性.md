---
layout: post
title:  "微服务下，如何保证服务可用性"
date:  2017-07-09
categories: [实践微服务]
keywords: spring cloud,hystrix,微服务
---


## 背景
最近经常被强调最多就是弱依赖降级，强依赖重试，db服务容灾的。被强调的原因是已经有好几例由于由于网络原因造成的重大事故了。
如今，微服务有兴起的苗头，已经感觉到很多公司都在尝试基于spring cloud来建设微服务，虽然不一定成型，但是服务已经被拆的越来越细。在这种情况下，我们经常被要求服务高可用，那么服务高可用到底需要具备哪些特征呢。


## 高可用服务基本特征
下面的每个点都值得深入写一篇博客，深入的学习和探讨。
### 服务容灾
对于服务降级，已经不是一个新鲜的话题了，淘宝的dubbo，新浪的motan都实现了简单的降级功能。但是这两个对服务降级的实现都比较简陋。如motan早期仅仅实现了failfast和failover的容灾策略。尽管这两种是最简单有效的策略，使用者也可以自行进行扩展容灾策略。但是依然还是会有些受限。至少不像Hystrix那么优雅。

#### 强依赖重试
对于强依赖的服务，也就是没办法降级处理的服务，我们可以选择直接抛出异常，让业务调用方感知，由调用方决定是否重试。但是，有的时候我们提供平台服务，不希望把这些复杂性丢给业务调用方，（而且业务调用方重试会对整个链路进行重试，很多时候我们失败，仅仅是由于中间某个强依赖环节失败，服务端重试仅仅需要针对失败的强依赖服务重试）我们需要在服务端对强依赖进行重试。

#### 弱依赖降级
对于弱依赖，这种情况下Hystrix比较好办，直接实现fallback方法，失败的时候直接交由fallback处理。fallback方法里面可以返回默认值。
#### 舱壁隔离

### 服务隔离
服务隔离按粒度又可以分为进程隔离和线程隔离。我们 可以同时做到进程隔离，然后在进程内做线程隔离。
#### 进程隔离
现在比较老的服务一般都是一个服务包含很多功能，比如既包含用户服务，有包含支付服务。当用户服务不可用的时候，导致支付服务不可用，这样是不合理的。所以对于这些明显属于两种不同职责的服务，我们有必要将其拆成不同的服务进程。隔离起来，相互不影响。

#### 线程隔离
国内的RPC对线程隔离实现的都比较弱。这里还是推荐Netflix的Hystrix，不同的Command可以使用不同的线程池。

### 单点问题
#### 应用单点
####  缓存单点
#### db单点

## 后记
以spring cloud的生态链应该就是以后java技术栈的大趋势了，spring 包装netflix的组件对上面的大多数问题基本上都给出了优雅的解决方案。
当然，由于个人理解有限，本文不保证严谨。随着理解的深入，会持续更改。