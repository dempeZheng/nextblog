---
layout: post
title:  "金融灾备落地实践"
date:  2017-09-21 12:39:04
type: 灾备
categories: [灾备]
keywords: 两地三中心,异地多活,金融灾备
---
## 写在前面
灾备的本质是冗余数据，而冗余的副作用就是带来数据一致性的问题。对于金融的业务场景，有些经典的强一致性场景。而这些强一致性场景就是金融灾备的难点所在。
## 经典场景
1）**余额扣减**
2）**库存扣减**
这两个场景是灾备的经典场景，也是金融难点，使我们要解决的核心问题。
如果余额不能保证强一致性，就有可能出现超扣的情况，比如用户只有100元，却扣掉了200元，这样就凭空产生了100元，这个就是大问题了。库存扣减同理。
而充值同样是金钱相关的重要业务，但是就没有上面的问题，充值的本质是给账户加钱，加钱不会产生负数，即便冗余了数据，只要最终同步了，就能保证数据最终一致。


## 灾备的演变

### 同城“双活”

![Alt text](/images/same-city.png)
阿里早期的架构就是同城“`双活`”，而这个双活是业务层的双活，DB层还是单点写。机房B的数据库作为机房B的冷备，
故障的时候，将冷备机房的数据库切换为master。一般不经过多次演练，切换的风险还是比较高的。

### 同城“双活”，异地只读
![Alt text](/images/different-city.png)


### 两地三中心

### 异地多活

## 灾备实施要点
### 数据同步
1）mysql的binlog复制
2）otter同步

#### 数据同步监控

### 切换方案

### 切换演练



## 落地要点
1）明确需求，结合实际情况，选取合适的架构，适合的才是最好的；
2）剥离边缘业务，关注重点，不要被边缘业务干扰；
3）切换演练


## 总结
关于金融灾备一直都是说的多，落地的少；现在除了阿里一些大公司有实力做异地双活，大部分的灾备方案也就是冷备，即便落地了，碰到机房故障的，没几个敢切的，最重要的是冷备还浪费机器。
但是，即便是有这么多缺点，但是依然很多公司乐此不疲的推动灾备的事情，因为大家已经意识到这个问题的重要性，对于金融灾备本质上不是一个可选项，是必须解决的一个问题。
所以，最好的情况是灾备我们必须实施，同时尽可能的降低切换的可能。

## 参考资料
